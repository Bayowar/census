---
title: "WORKSHOP: What happened to *Chocolate City*?"
subtitle: "The Mathematics of Racial and Residential Segregation in Washington, DC"
author: "The Quant Shop + Nubian Hueman"
description: "Using US census data to explore racial and residential segregation."
draft: true
bibliography: references.bib
csl: apa.csl
css: style.css
always_allow_html: true
output:
  html_document:
    toc: false
    toc_depth: 2
    number_sections: false
    self_contained: yes
    mode: selfcontained
    rmdformats::readthedown:
    prettydoc::html_pretty:
      theme: architect
  pdf_document:
    toc: false
    toc_depth: 2
    number_section: false 
  word_document:
    toc: false
    reference_docx: word-styles-reference.docx
geometry: margin=1.0in
editor_options:
  markdown:
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, # By default, hide code; set to TRUE to see code
  fig.pos = 'th', # Places figures at top or here
  out.width = '100%', dpi = 300, # Figure resolution and size
  fig.env="figure"
) # Latex figure environment

library(here)
here::i_am("what-happened-to-chocolate-city.Rmd")

# install.packages("tidycensus")
# install.packages("rmarkdown")
# install.packages("tm")
install.packages(c("survey", "srvyr"), repos = "http://cran.us.r-project.org")

## load libraries
### general libraries
library(ggplot2)
library(dplyr)
library(knitr)
library(tidyverse)
library(dplyr)
library(readtext)
library(tidyverse)
library(kableExtra)
library(rmarkdown)
layout="l-body-outset"
options(knitr.table.format = "latex") # For kable tables to write LaTeX table directly

### program specific libraries
library(sf)
library(tm)
library(tidycensus)
library(gt)
library(segregation)
library(tigris)
library(tmap)
library(rmapshaper)
library(flextable)
```

\vfill

```{r, echo=FALSE,out.width="50%", out.height="30%",fig.show='hold',fig.align='center'}
# knitr::include_graphics(c("img/quant_workshop_logo.png","img/nubian-hueman.png"))
``` 

\vfill

**Project Team**: 

Nathan Alexander (Howard University)

Anika Hobson (Nubian Hueman)

Zoe Williams (Howard University)

Qyana Stewart (Howard University)

\newpage

# OVERVIEW

Whatever happened to *Chocolate City*, the term used to refer to Washington DC's Black population? 

In this short report, we discuss some key historical and contemporary connections and then we analyze US census data to examine historical and continual shifts in Washington DC's Black population. We focus on racial isolation and residential segregation. We close with a discussion on how modern critical theories, mathematics, and population-level data can increase our general knowledge as a community and inform our perspectives on local policies and social action issues, like voting and community service.

*The materials presented here are for the October 2024 workshop at Nubian Hueman studios in DC.*

\newpage

# BACKGROUND

The phrase "Chocolate City" has long been used to describe Washington, D.C.'s significant Black population and vibrant Black communities. However, in recent decades, the appropriateness of this label has come into question due to shifting demographics and changing urban dynamics.

Washington, D.C. reached its peak as a majority-Black city in 1970, when African Americans comprised 71% of the population. Since then, the city has experienced a steady decline in its Black population. By 2015, DC's population of Black residents had decreased to 48% and the current population is 44%.

## Factors contributing to the changes

Several factors have contributed to the erosion of D.C.'s status as a "Chocolate City":

- Gentrification: Rising property values and cost of living have pushed many long-time Black residents out of traditionally African American neighborhoods

- Suburban migration: Many middle-class Black families have moved to more affordable suburbs in Maryland and Virginia

- Urban redevelopment: The replacement of public housing projects with mixed-income developments has altered the demographic makeup of some areas

## Segregation

Despite increasing diversity, Washington, D.C. remains highly segregated. The Black-White segregation index stood at 70 in 2015, showing only modest improvement from 77 in 1980. This suggests that while the overall racial composition of the city has changed, residential patterns of segregation persist, often isolating poor Black residents.

## Cultural significance

The "Chocolate City" moniker continues to hold cultural significance, even as its demographic accuracy wanes. It represented not just a statistical majority, but also the city's important role in Black history, culture, and political aspirations. As Washington, D.C. evolves, the question remains whether the "Chocolate City" label will continue to resonate or if new descriptors will emerge to capture the city's changing identity.

## Implications

As of 2022, the racial composition of Washington, D.C. has changed considerably:

    Black or African American (Non-Hispanic): 43.5%
    White (Non-Hispanic): 36.3%
    Hispanic (of any race): 4.05%
    Asian (Non-Hispanic): 3.95%
    Two or more races (Non-Hispanic): 3.94%

This shift represents a significant change from the city's historical Black majority.

In this workshop, we examine the various quantitative and historical factors that have contributed race and isolation in DC.

# DATA

The discussions and analysis in this report are informed by the US Census microdata, which was accessed through the `tidycensus()` package in R. The American Community Survey (ACS) Public Use Microdata Sample (PUMS) is used to analyze pre-aggregate data at a local level. This data allowed us to make various custom estimates that may not be normally available by the US Census Bureau. 

Learn more about PUMS [here](https://www.census.gov/programs-surveys/acs/microdata.html).

\newpage

```{r, include=F, warning=F}
### PUMS (Public Use Microdata Sample) variables
pums_vars_2022 <- pums_variables %>% 
  filter(year == 2022, survey == "acs1")
pums_vars_2022 %>% 
  distinct(var_code, var_label, data_type, level)
pums_vars_2022
```


```{r, include=F, warning=F}
### 2016-2020 census tract data
dc.tracts <- get_acs(geography="tract",
                     year = 2020,
                     variables = c(totalpop = "B03002_001",
                                   white = "B03002_003", 
                                   black = "B03002_004", # Black alone
                                   asian = "B03002_006", 
                                   hispanic = "B03002_012",
                                   income = "B19013_001"), # Median household income
                     state = "DC",
                     survey = "acs5",
                     output = "wide",
                     geometry = T)

# Calculate proportions 
dc.tracts.mod <- dc.tracts %>% 
  mutate(pwhite = 100*(whiteE/totalpopE), 
         pblack = 100*(blackE/totalpopE), 
         pasian = 100*(asianE/totalpopE), 
         phisp = 100*(hispanicE/totalpopE)) %>%
  select(GEOID,
         totalpopE, 
         pwhite, 
         pblack, 
         pasian, 
         phisp,
         whiteE, 
         blackE,
         asianE,
         hispanicE,
         incomeE)

# City boundaries
pl <- places(state = "DC", year = 2020, cb = TRUE)

tracts <- dc.tracts.mod %>%
          st_join(pl)
tracts
```

In our data, "totalpopE" is a single number representing the estimated population, while "totalpopM" represents a range around that estimate within which the true population is likely to fall. The designation for "E" and "M" follows in line as the estimate and the margin of error.

```{r, include=T, warning=F}
tracts %>%
  tm_shape(unit = "mi") +
    tm_polygons(col = "pblack", style = "quantile", palette = "Reds", 
              border.alpha = 0, title = "") +
    tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.75, position = c("right", "bottom")) + 
  tm_layout(main.title = "Percent Black Population by DC Tracts (2022)", 
            main.title.size = 0.9, frame = FALSE)

```

\newpage

```{r}
# Example: Index of Dissimilarity calculation
calculate_dissimilarity <- function(data, group_var, total_var) {
  total_group <- sum(data[[group_var]])
  total_pop <- sum(data[[total_var]])
  
  data %>%
    mutate(
      pi = !!sym(group_var) / total_group,
      pj = (!!sym(total_var) - !!sym(group_var)) / (total_pop - total_group)
    ) %>%
    summarize(d = 0.5 * sum(abs(pi - pj))) %>%
    pull(d)
}
```

\newpage

```{r}
dc.tracts <- dc.tracts[!is.na(dc.tracts$incomeE), ]

dc_income <- dc.tracts %>%
  mutate(incomeE = case_when(
      incomeE < quantile(incomeE, 0.2) ~ "Lowest Quintile",
      incomeE < quantile(incomeE, 0.4) ~ "Second Quintile",
      incomeE < quantile(incomeE, 0.6) ~ "Middle Quintile",
      incomeE < quantile(incomeE, 0.8) ~ "Fourth Quintile",
      TRUE ~ "Highest Quintile"
    )
  )

tm_shape(dc_income) +
  tm_fill("incomeE", palette = "Greens", title = "DC Income Distribution")
```

\newpage

```{r}
dc_black_income <- get_acs(
  geography = "tract",
  variables = c(
    "B19001B_002", "B19001B_003", "B19001B_004", # Low income
    "B19001B_005", "B19001B_006", "B19001B_007", # Middle income
    "B19001B_008", "B19001B_009", "B19001B_010", "B19001B_011" # High income
  ),
  state = "DC",
  year = 2020,
  geometry = TRUE
) %>%
  group_by(GEOID) %>%
  summarize(
    low_income = sum(estimate[variable %in% c("B19001B_002", "B19001B_003", "B19001B_004")]),
    middle_income = sum(estimate[variable %in% c("B19001B_005", "B19001B_006", "B19001B_007")]),
    high_income = sum(estimate[variable %in% c("B19001B_008", "B19001B_009", "B19001B_010", "B19001B_011")])
  )

tm_shape(dc_black_income) +
  tm_fill(c("low_income", "middle_income", "high_income"), 
          palette = "YlGn", 
          title = c("Low Income", "Middle Income", "High Income"))
```

```{r}
dc_black_median <- get_acs(
  geography = "tract",
  variables = c("B19013B_001"), # Median income for Black households
  state = "DC",
  year = 2020,
  geometry = TRUE
)

dc_black_quintiles <- dc_black_median %>%
  mutate(
    income_group = case_when(
      estimate < quantile(estimate, 0.2, na.rm = TRUE) ~ "Lowest Quintile",
      estimate > quantile(estimate, 0.8, na.rm = TRUE) ~ "Highest Quintile",
      TRUE ~ "Middle Quintiles"
    )
  )

tm_shape(dc_black_quintiles) +
  tm_fill("income_group", palette = "Set2", title = "Black Income Quintiles")

```

```{r}
# Get census data for DC
dc_data <- get_acs(
  geography = "tract",
  variables = c(
    "B19013B_001", # Median income for Black households
    "B02001_003",  # Black population
    "B02001_001"   # Total population
  ),
  state = "DC",
  year = 2020,
  geometry = TRUE
)

# Reshape the data
dc_data_wide <- dc_data %>%
  select(-moe) %>%
  pivot_wider(names_from = variable, values_from = estimate)

# Calculate Black income quintiles
dc_black_quintiles <- dc_data_wide %>%
  mutate(
    black_pct = B02001_003 / B02001_001,
    income_quintile = ntile(B19013B_001, 5)
  )
```



```{r}
calculate_dissimilarity <- function(data, group_var, total_var) {
  total_group <- sum(data[[group_var]], na.rm = TRUE)
  total_pop <- sum(data[[total_var]], na.rm = TRUE)
  
  data %>%
    mutate(
      pi = !!sym(group_var) / total_group,
      pj = (!!sym(total_var) - !!sym(group_var)) / (total_pop - total_group)
    ) %>%
    summarize(d = 0.5 * sum(abs(pi - pj), na.rm = TRUE)) %>%
    pull(d)
}

dissimilarity_indices <- dc_black_quintiles %>%
  group_by(income_quintile) %>%
  calculate_dissimilarity(., "B02001_003", "B02001_001")

print(dissimilarity_indices)
```

```{r}
tm_shape(dc_black_quintiles) +
  tm_fill("income_quintile", 
          title = "Black Income Quintiles",
          palette = "Reds",
          style = "jenks") +
  tm_borders() +
  tm_layout(title = "Spatial Distribution of Black Income Quintiles in DC")
```

```{r}
tracts.mod <- tracts %>%
      group_by(NAME) %>%
      mutate(white.tot = sum(whiteE), 
             asian.tot = sum(asianE), 
             black.tot = sum(blackE), 
             hisp.tot = sum(hispanicE), 
             tpopc = sum(totalpopE)) %>%
      ungroup()
tracts.mod
```

```{r}
# Example for Hispanic population
dc_hispanic_data <- get_acs(
  geography = "tract",
  variables = c(
    "B19013I_001", # Median income for Hispanic households
    "B03002_012",  # Hispanic population
    "B02001_001"   # Total population
  ),
  state = "DC",
  year = 2020,
  geometry = TRUE
)

# Reshape and calculate quintiles for Hispanic population
dc_hispanic_quintiles <- dc_hispanic_data %>%
  select(-moe) %>%
  pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    hispanic_pct = B03002_012 / B02001_001,
    income_quintile = ntile(B19013I_001, 5)
  )

# Calculate dissimilarity index for Hispanic population
hispanic_dissimilarity_indices <- dc_hispanic_quintiles %>%
  group_by(income_quintile) %>%
  calculate_dissimilarity(., "B03002_012", "B02001_001")

print(hispanic_dissimilarity_indices)
```

```{r}
comparison_df <- bind_cols(
  dissimilarity_indices,
  hispanic_dissimilarity_indices) %>% 
   rename(Black = "...1") %>% 
   rename(Hispanic = "...2")

comparison_df # by quintile

```


### Map: Washington, DC

```{r out.width='100%', echo=FALSE}
library(leaflet)
leaflet() %>% addTiles() %>%
  setView(-77.0369, 38.8977, zoom = 10) %>%
  addPopups(
    -77.0369, 38.8977,
    'This is <b>Washington, DC</b>, or Chocolate City.'
  )
```
